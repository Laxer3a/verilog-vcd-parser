# Visual Studio Setup Guide

This guide explains how to build the multithreaded verilog-vcd-parser library using Visual Studio on Windows.

## Prerequisites

### 1. Visual Studio

- **Visual Studio 2022** (recommended) or **Visual Studio 2019**
- Install with "Desktop development with C++" workload
- Download from: https://visualstudio.microsoft.com/

### 2. Win Flex-Bison

Since Flex and Bison are Unix tools, you need Windows ports:

**Option A: WinFlexBison (Recommended)**

1. Download from: https://github.com/lexxmark/winflexbison/releases
2. Get the latest `win_flex_bison-latest.zip`
3. Extract to `C:\winflexbison\` (or your preferred location)
4. Add `C:\winflexbison\` to your PATH:
   - Right-click "This PC" → Properties
   - Advanced system settings → Environment Variables
   - Edit "Path" under System variables
   - Add new entry: `C:\winflexbison\`

**Option B: Chocolatey Package Manager**

```powershell
# Run in Administrator PowerShell
choco install winflexbison3
```

**Option C: MSYS2** (for those who prefer Unix-like environment)

```bash
# In MSYS2 terminal
pacman -S flex bison
```

### 3. Verify Installation

Open a **new** Command Prompt (after modifying PATH):

```cmd
win_flex --version
win_bison --version
```

Or if using MSYS2/other packages:

```cmd
flex --version
bison --version
```

## Project Structure

```
verilog-vcd-parser/
├── verilog-vcd-parser.sln          # Visual Studio Solution
├── verilog-vcd-parser.vcxproj      # Library project
├── src/
│   ├── VCDScanner.l                # Flex lexer source
│   ├── VCDParser.ypp               # Bison parser source
│   ├── VCDFileParser.cpp/hpp       # Main parser driver
│   ├── VCDFile.cpp/hpp             # VCD file representation
│   └── VCDValue.cpp/hpp            # VCD value types
├── build/                          # Generated files (create this)
│   ├── VCDScanner.cpp/hpp          # Generated by Flex
│   └── VCDParser.cpp/hpp           # Generated by Bison
└── test/
    ├── test_multithread.cpp        # Multithreading tests
    └── test_multithread.vcxproj    # Test project
```

## Building the Library

### Step 1: Generate Parser and Lexer Files

Before opening Visual Studio, you **must** generate the lexer and parser C++ files from the .l and .ypp sources.

**Open Command Prompt in the project root directory:**

```cmd
cd path\to\verilog-vcd-parser
```

**Create the build directory:**

```cmd
mkdir build
```

**Generate parser (Bison):**

```cmd
win_bison -v --defines=build\VCDParser.hpp src\VCDParser.ypp -o build\VCDParser.cpp
```

Or if using flex/bison directly:

```cmd
bison -v --defines=build/VCDParser.hpp src/VCDParser.ypp -o build/VCDParser.cpp
```

**Generate lexer (Flex):**

```cmd
win_flex -P VCDParser --header-file=build\VCDScanner.hpp -o build\VCDScanner.cpp src\VCDScanner.l
```

Or:

```cmd
flex -P VCDParser --header-file=build/VCDScanner.hpp -o build/VCDScanner.cpp src/VCDScanner.l
```

**Verify generated files exist:**

```cmd
dir build
```

You should see:
- `VCDParser.cpp`
- `VCDParser.hpp`
- `VCDScanner.cpp`
- `VCDScanner.hpp`

### Step 2: Open Solution in Visual Studio

1. Double-click `verilog-vcd-parser.sln`
2. Visual Studio will load the solution with two projects:
   - `verilog-vcd-parser` (library)
   - `test_multithread` (test executable)

### Step 3: Build the Library

1. Select build configuration: **Debug** or **Release**
2. Select platform: **x64** (recommended) or **Win32**
3. **Build** → **Build Solution** (or press `Ctrl+Shift+B`)

Output will be in:
- `build\x64\Debug\verilog-vcd-parser.lib` (Debug)
- `build\x64\Release\verilog-vcd-parser.lib` (Release)

### Step 4: Build and Run Tests

1. In Solution Explorer, right-click `test_multithread` project
2. **Set as StartUp Project**
3. **Build** → **Build test_multithread**
4. **Debug** → **Start Without Debugging** (or press `Ctrl+F5`)

The test will:
- Generate temporary VCD files
- Parse them using multiple threads
- Verify correctness
- Report results to console

Expected output:

```
======================================
VCD Parser Multithreading Test Suite
======================================

=== Test 1: Basic Concurrency (4 threads) ===
[Thread 0] Parsing test_vcd_0.vcd...
[Thread 0] Success! 10 signals, 100 timestamps, 15 ms
...
Results: 4 successful, 0 failed

=== Test 2: Stress Test (20 threads) ===
...
Results: 20 successful, 0 failed

======================================
All tests PASSED!
======================================
```

## Batch Build Script (Optional)

Create `build.bat` in the project root:

```batch
@echo off
echo ========================================
echo VCD Parser Build Script
echo ========================================

echo.
echo [1/4] Creating build directory...
if not exist build mkdir build

echo.
echo [2/4] Generating parser with Bison...
win_bison -v --defines=build\VCDParser.hpp src\VCDParser.ypp -o build\VCDParser.cpp
if errorlevel 1 (
    echo ERROR: Bison failed
    exit /b 1
)

echo.
echo [3/4] Generating lexer with Flex...
win_flex -P VCDParser --header-file=build\VCDScanner.hpp -o build\VCDScanner.cpp src\VCDScanner.l
if errorlevel 1 (
    echo ERROR: Flex failed
    exit /b 1
)

echo.
echo [4/4] Building with MSBuild...
msbuild verilog-vcd-parser.sln /p:Configuration=Release /p:Platform=x64 /m
if errorlevel 1 (
    echo ERROR: Build failed
    exit /b 1
)

echo.
echo ========================================
echo Build completed successfully!
echo Output: build\x64\Release\
echo ========================================
```

Run it:

```cmd
build.bat
```

## Using the Library in Your Visual Studio Project

### Method 1: Add as Existing Project

1. In your solution, right-click → **Add** → **Existing Project**
2. Browse to `verilog-vcd-parser.vcxproj`
3. Add project dependency:
   - Right-click your project → **Build Dependencies** → **Project Dependencies**
   - Check `verilog-vcd-parser`

### Method 2: Link Against the .lib File

1. Copy `verilog-vcd-parser.lib` to your project
2. In your project properties:
   - **C/C++** → **Additional Include Directories**: Add `path\to\verilog-vcd-parser\src` and `path\to\verilog-vcd-parser\build`
   - **Linker** → **Additional Library Directories**: Add directory containing the .lib
   - **Linker** → **Input** → **Additional Dependencies**: Add `verilog-vcd-parser.lib`

### Example Code

```cpp
#include "VCDFileParser.hpp"
#include <iostream>
#include <thread>
#include <vector>

void parse_vcd(const std::string& filename) {
    VCDFileParser parser;
    VCDFile* trace = parser.parse_file(filename);

    if (trace) {
        std::cout << filename << ": "
                  << trace->get_signals()->size() << " signals\n";
        delete trace;
    }
}

int main(int argc, char** argv) {
    std::vector<std::thread> threads;

    for (int i = 1; i < argc; ++i) {
        threads.emplace_back(parse_vcd, argv[i]);
    }

    for (auto& t : threads) {
        t.join();
    }

    return 0;
}
```

Compile with:
- C++ Language Standard: **C++17** or **C++14** (minimum C++11)
- Multi-threaded support is automatic in MSVC

## Troubleshooting

### Error: "Cannot open include file: 'unistd.h'"

**Problem**: Flex-generated code tries to include Unix header `unistd.h`

**Solution 1**: Add this to your project preprocessor definitions:
```
YY_NO_UNISTD_H
```

In Visual Studio:
- Project Properties → C/C++ → Preprocessor → Preprocessor Definitions
- Add: `YY_NO_UNISTD_H`

**Solution 2**: Create a dummy `unistd.h` in your include path:

```c
// unistd.h (dummy for Windows)
#ifndef _UNISTD_H
#define _UNISTD_H
#include <io.h>
#include <process.h>
#endif
```

### Error: "win_bison: command not found"

**Problem**: WinFlexBison not in PATH or not installed

**Solution**:
1. Download WinFlexBison from https://github.com/lexxmark/winflexbison/releases
2. Extract to a folder (e.g., `C:\winflexbison\`)
3. Add to PATH (see Prerequisites section)
4. Open a **new** Command Prompt (PATH changes don't apply to existing windows)

### Error: MSBuild version mismatch

**Problem**: Project created with newer VS than you have

**Solution**: Edit `.vcxproj` files and change:
```xml
<PlatformToolset>v143</PlatformToolset>  <!-- VS 2022 -->
```
to:
```xml
<PlatformToolset>v142</PlatformToolset>  <!-- VS 2019 -->
```

### Warnings about deprecated Bison directives

These warnings are harmless:
```
warning: deprecated directive: '%define parser_class_name {parser}'
warning: deprecated directive: '%name-prefix "VCDParser"'
```

They can be ignored. The parser will work correctly.

### Link Error: "unresolved external symbol yylex"

**Problem**: Parser and lexer not properly linked

**Solution**:
1. Make sure both `VCDParser.cpp` and `VCDScanner.cpp` are in the project
2. Rebuild entire solution (clean + build)
3. Check that `#define yylex driver.get_next_token` is present in parser code

## Performance Tips

1. **Release Build**: Use Release configuration for best performance
2. **Optimization**: Enable `/O2` (Maximize Speed)
3. **Thread Count**: Use `std::thread::hardware_concurrency()` to get optimal thread count
4. **Large Files**: Consider memory usage with many threads parsing large files

## Advanced: Custom Build Events

To automatically regenerate parser/lexer before build, add a Pre-Build Event:

1. Project Properties → Build Events → Pre-Build Event
2. Command Line:

```cmd
if not exist $(ProjectDir)build mkdir $(ProjectDir)build
win_bison -v --defines=$(ProjectDir)build\VCDParser.hpp $(ProjectDir)src\VCDParser.ypp -o $(ProjectDir)build\VCDParser.cpp
win_flex -P VCDParser --header-file=$(ProjectDir)build\VCDScanner.hpp -o $(ProjectDir)build\VCDScanner.cpp $(ProjectDir)src\VCDScanner.l
```

This ensures parser/lexer are always up-to-date.

## See Also

- [BUILD_INSTRUCTIONS.md](BUILD_INSTRUCTIONS.md) - Unix/Linux build instructions
- [MULTITHREADING.md](MULTITHREADING.md) - Detailed threading documentation
- [README.md](README.md) - Project overview

## Support

For Visual Studio specific issues:
1. Check this guide
2. Verify Flex/Bison are properly installed and in PATH
3. Ensure generated files exist in `build/` directory
4. Try clean rebuild
5. Check Output window for detailed error messages
